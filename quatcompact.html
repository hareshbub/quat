<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>QUAT Compact</title>

<style>
:root{
  --quat-green:#22c55e;
  --quat-blue:#2563eb;
  --quat-purple:#7c3aed;
  --quat-bg:#020617;
  --quat-border:#64748b;
}

body{
  background:#0f172a;
  color:#e5e7eb;
  font-family:system-ui,sans-serif;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}

#quat{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:10px;
}

/* ===== HERO ===== */
#quatHero{
  display:flex;
  align-items:center;
  gap:14px;
}

.circle{
  width:46px;height:46px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-weight:700;cursor:pointer;
  user-select:none;
  background:var(--quat-blue);
}
.circle.submit{background:var(--quat-purple);}

.boxes{display:flex;gap:6px;}
.box{
  width:38px;height:38px;
  border:2px solid var(--quat-border);
  background:var(--quat-bg);
  display:flex;align-items:center;justify-content:center;
  font-weight:700;
}
.box.active{
  background:var(--quat-green);
  color:#022c22;
  border-color:var(--quat-green);
}

/* ===== VERIFIED STATE ===== */
#verified{
  display:none;
  align-items:center;
  gap:8px;
  color:var(--quat-green);
  font-size:16px;
  font-weight:600;
}

/* ===== FOOTER ===== */
#retry{
  display:none;
  background:none;
  border:none;
  color:#94a3b8;
  font-size:12px;
  cursor:pointer;
}
#retry:hover{color:#e5e7eb;}
</style>
</head>

<body>

<div id="quat">

  <!-- HERO -->
  <div id="quatHero">
    <div class="circle" id="tap">●</div>

    <div class="boxes">
      <div class="box"></div>
      <div class="box"></div>
      <div class="box"></div>
      <div class="box"></div>
    </div>

    <div class="circle submit" id="submit">●</div>
  </div>

  <!-- VERIFIED -->
  <div id="verified">✔ Verified by QUAT</div>

  <!-- RETRY -->
  <button id="retry">Try again</button>

</div>

<script>
/* ===== LOCK CONSOLE ===== */
(()=>{["log","warn","error","debug","info","trace"].forEach(k=>console[k]=()=>{});})();

/* ===== CONFIG ===== */
const LETTERS=["Q","U","A","T"];
const MIN=80,MAX=350;
const ENTROPY_THRESHOLD=1.8;
const MIN_UNIQUE=8;

/* ===== DEVICE ===== */
const IS_TOUCH=("ontouchstart"in window)||navigator.maxTouchPoints>0;
const USE_ENTROPY=!IS_TOUCH;

/* ===== STATE ===== */
let clicks=[],moves=[],submitted=false,last=null;

/* ===== ELEMENTS ===== */
const boxes=document.querySelectorAll(".box");
const hero=document.getElementById("quatHero");
const verified=document.getElementById("verified");
const retry=document.getElementById("retry");
const tap=document.getElementById("tap");
const submit=document.getElementById("submit");

/* ===== BLOCK KEYS ===== */
["keydown","keypress","keyup"].forEach(e=>{
  window.addEventListener(e,ev=>{
    ev.preventDefault();ev.stopPropagation();
  },{passive:false});
});

/* ===== ENTROPY (DESKTOP ONLY) ===== */
if(USE_ENTROPY){
  window.addEventListener("pointermove",e=>{
    if(submitted||!e.isTrusted||e.pointerType!=="mouse") return;
    if(last){
      const dx=e.clientX-last.x;
      const dy=e.clientY-last.y;
      if(dx||dy){
        moves.push({x:dx,y:dy});
        if(moves.length>150)moves.shift();
      }
    }
    last={x:e.clientX,y:e.clientY};
  });
}

/* ===== ENTROPY CHECK ===== */
function entropyOK(){
  if(!USE_ENTROPY) return true;
  if(moves.length<30) return false;

  const mags=moves.map(p=>Math.hypot(p.x,p.y).toFixed(1));
  const unique=new Set(mags).size;
  const freq={}; mags.forEach(m=>freq[m]=(freq[m]||0)+1);

  let H=0,n=mags.length;
  for(const k in freq){
    const p=freq[k]/n;
    H-=p*Math.log2(p);
  }
  return H>=ENTROPY_THRESHOLD && unique>=MIN_UNIQUE;
}

/* ===== UI ===== */
function paint(){
  boxes.forEach((b,i)=>{
    b.classList.toggle("active",i<clicks.length);
    b.textContent=i<clicks.length?LETTERS[i]:"";
  });
}

/* ===== RESET ===== */
function resetAll(){
  clicks=[];moves=[];submitted=false;last=null;
  boxes.forEach(b=>{b.classList.remove("active");b.textContent="";});
  hero.style.display="flex";
  verified.style.display="none";
  retry.style.display="none";
}

/* ===== TAP ===== */
tap.addEventListener("pointerdown",e=>{
  if(submitted||!e.isTrusted||clicks.length>=4) return;
  clicks.push(performance.now());
  paint();
});

/* ===== SUBMIT ===== */
submit.addEventListener("pointerdown",e=>{
  if(submitted||!e.isTrusted) return;
  submitted=true;

  if(clicks.length!==4) return resetAll();

  const t=[
    clicks[1]-clicks[0],
    clicks[2]-clicks[1],
    clicks[3]-clicks[2]
  ];
  const timingOK=t.every(v=>v>=MIN&&v<=MAX);
  const pass=timingOK && entropyOK();

  if(pass){
    hero.style.display="none";
    verified.style.display="flex";
    retry.style.display="block";
  }else{
    resetAll();
  }
});

/* ===== RETRY ===== */
retry.onclick=resetAll;
</script>

</body>
</html>
