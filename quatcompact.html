<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>QUAT Compact</title>

<style>
:root{
  --green:#22c55e;      /* boxes */
  --blue:#2563eb;       /* tap circle */
  --purple:#7c3aed;     /* submit circle */
  --bg:transparent;     /* background transparent */
  --border:#64748b;
  --text:#e5e7eb;
}

body{
  background:var(--bg);
  color:var(--text);
  font-family:system-ui,sans-serif;
  display:flex;
  align-items:center;
  justify-content:center;
  height:100%;
  margin:0;
}

#quat{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:8px;
}

#hero{
  display:flex;
  align-items:center;
  gap:14px;
}

.circle{
  width:46px;height:46px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-weight:700;cursor:pointer;
  user-select:none;
}
.circle.tap{background:var(--blue);}
.circle.submit{background:var(--purple);}

.boxes{display:flex;gap:6px;}
.box{
  width:38px;height:38px;
  border:2px solid var(--border);
  background:var(--green);
  display:flex;align-items:center;justify-content:center;
  font-weight:700;
  color:#022c22;
}

#status{
  font-size:13px;
  min-height:18px;
  text-align:center;
}
.success{color:var(--green);}
.fail{color:#ef4444;}
</style>
</head>

<body>

<div id="quat">
  <div id="hero">
    <div class="circle tap" id="tap">●</div>

    <div class="boxes">
      <div class="box"></div>
      <div class="box"></div>
      <div class="box"></div>
      <div class="box"></div>
    </div>

    <div class="circle submit" id="submit">●</div>
  </div>

  <div id="status"></div>
</div>

<script>
const LETTERS=["Q","U","A","T"];
const MIN=80,MAX=350;
const IS_TOUCH=("ontouchstart"in window)||navigator.maxTouchPoints>0;
let clicks=[],moves=[],submitted=false,last=null;

const boxes=document.querySelectorAll(".box");
const hero=document.getElementById("hero");
const status=document.getElementById("status");
const tap=document.getElementById("tap");
const submit=document.getElementById("submit");

function paint(){
  boxes.forEach((b,i)=>{
    b.classList.toggle("active",i<clicks.length);
    b.textContent=i<clicks.length?LETTERS[i]:"";
  });
}

function resetAll(){
  clicks=[];moves=[];submitted=false;last=null;
  boxes.forEach(b=>{b.classList.remove("active");b.textContent="";});
  status.textContent="";
}

tap.addEventListener("pointerdown",e=>{
  if(submitted||!e.isTrusted||clicks.length>=4) return;
  clicks.push(performance.now());
  paint();
});

submit.addEventListener("pointerdown",e=>{
  if(submitted||!e.isTrusted) return;
  submitted=true;

  if(clicks.length!==4){
    status.textContent="Complete QUAT first";
    status.className="fail";
    setTimeout(resetAll,700);
    return;
  }

  const t=[
    clicks[1]-clicks[0],
    clicks[2]-clicks[1],
    clicks[3]-clicks[2]
  ];

  const timingOK=t.every(v=>v>=MIN&&v<=MAX);
  const pass=IS_TOUCH ? timingOK : (timingOK && moves.length>0);

  status.className=pass?"success":"fail";
  status.textContent=pass?"✔ Verified by QUAT":"Verification failed";

  if(pass){
    window.parent.postMessage({type:"QUAT_PASS"}, "*");
  } else {
    setTimeout(resetAll,700);
  }
});
</script>

</body>
</html>
